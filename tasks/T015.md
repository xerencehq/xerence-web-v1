# T015: Google Analytics Integration

## Overview

**Task ID**: T015
**Phase**: 4 - Integrations
**Priority**: Medium
**Dependencies**: T001
**Estimated Complexity**: Low

## Objective

Integrate Google Analytics 4 (GA4) into the Next.js application with proper event tracking, page view tracking, and conversion tracking for the consultation booking CTA.

---

## Prerequisites

Before starting this task:
1. Read `CLAUDE.md` for agent rules
2. Check `EXECUTION.md` - Ensure T001 is `completed`
3. Mark this task as `in_progress` in `EXECUTION.md`
4. Read `SHARED_NOTES.md` for any relevant notes

---

## File Ownership

```
CREATE:
- src/lib/analytics/index.ts
- src/lib/analytics/gtag.ts
- src/lib/analytics/events.ts
- src/components/Common/Analytics/GoogleAnalytics.tsx
- src/__tests__/lib/analytics/gtag.test.ts
- src/__tests__/lib/analytics/events.test.ts

MODIFY:
- src/app/layout.tsx (add Analytics component - coordinate via SHARED_NOTES)
- .env.local (add GA_MEASUREMENT_ID)
- .env.example (document GA_MEASUREMENT_ID)
```

---

## Implementation

### Environment Variable

Add to `.env.local`:
```env
NEXT_PUBLIC_GA_MEASUREMENT_ID=G-XXXXXXXXXX
```

Add to `.env.example`:
```env
# Google Analytics
NEXT_PUBLIC_GA_MEASUREMENT_ID=
```

### Google Analytics Component

#### `src/components/Common/Analytics/GoogleAnalytics.tsx`
```typescript
'use client';

import Script from 'next/script';
import { usePathname, useSearchParams } from 'next/navigation';
import { useEffect, Suspense } from 'react';
import { pageview } from '@/lib/analytics/gtag';

const GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;

function GoogleAnalyticsInner() {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (pathname && GA_MEASUREMENT_ID) {
      const url = pathname + (searchParams?.toString() ? `?${searchParams.toString()}` : '');
      pageview(url);
    }
  }, [pathname, searchParams]);

  return null;
}

export default function GoogleAnalytics() {
  if (!GA_MEASUREMENT_ID) {
    return null;
  }

  return (
    <>
      <Script
        strategy="afterInteractive"
        src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}
      />
      <Script
        id="google-analytics"
        strategy="afterInteractive"
        dangerouslySetInnerHTML={{
          __html: `
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${GA_MEASUREMENT_ID}', {
              page_path: window.location.pathname,
            });
          `,
        }}
      />
      <Suspense fallback={null}>
        <GoogleAnalyticsInner />
      </Suspense>
    </>
  );
}
```

### GTAG Utilities

#### `src/lib/analytics/gtag.ts`
```typescript
export const GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;

// Type definitions for gtag
declare global {
  interface Window {
    gtag: (
      command: 'config' | 'event' | 'js',
      targetId: string | Date,
      config?: Record<string, unknown>
    ) => void;
    dataLayer: unknown[];
  }
}

// Check if analytics is available
export const isAnalyticsAvailable = (): boolean => {
  return typeof window !== 'undefined' && !!GA_MEASUREMENT_ID && !!window.gtag;
};

// Track page views
export const pageview = (url: string): void => {
  if (!isAnalyticsAvailable()) return;

  window.gtag('config', GA_MEASUREMENT_ID!, {
    page_path: url,
  });
};

// Track events
export const event = (
  action: string,
  category: string,
  label?: string,
  value?: number
): void => {
  if (!isAnalyticsAvailable()) return;

  window.gtag('event', action, {
    event_category: category,
    event_label: label,
    value: value,
  });
};

// Track conversions
export const trackConversion = (conversionId: string, value?: number): void => {
  if (!isAnalyticsAvailable()) return;

  window.gtag('event', 'conversion', {
    send_to: conversionId,
    value: value,
  });
};
```

### Event Tracking Utilities

#### `src/lib/analytics/events.ts`
```typescript
import { event, trackConversion } from './gtag';

// CTA Events
export const trackCTAClick = (ctaName: string, location: string): void => {
  event('cta_click', 'engagement', `${ctaName} - ${location}`);
};

export const trackConsultationBooking = (): void => {
  event('consultation_booking', 'conversion', 'book_consultation_page');
  // If you have a Google Ads conversion ID, uncomment:
  // trackConversion('AW-CONVERSION_ID/CONVERSION_LABEL');
};

// Navigation Events
export const trackNavigation = (destination: string): void => {
  event('navigation', 'engagement', destination);
};

// Project Events
export const trackProjectView = (projectName: string): void => {
  event('project_view', 'engagement', projectName);
};

export const trackProjectFilter = (filterType: string, filterValue: string): void => {
  event('project_filter', 'engagement', `${filterType}: ${filterValue}`);
};

// Contact Events
export const trackContactFormSubmit = (): void => {
  event('contact_form_submit', 'conversion', 'contact_page');
};

export const trackLeadQualifierSubmit = (budget: string): void => {
  event('lead_qualifier_submit', 'conversion', budget);
};

// Outbound Links
export const trackOutboundLink = (url: string): void => {
  event('outbound_click', 'engagement', url);
};

// Social Links
export const trackSocialClick = (platform: string): void => {
  event('social_click', 'engagement', platform);
};

// Scroll Depth
export const trackScrollDepth = (percentage: number): void => {
  event('scroll_depth', 'engagement', `${percentage}%`, percentage);
};
```

### Index Export

#### `src/lib/analytics/index.ts`
```typescript
export { GA_MEASUREMENT_ID, isAnalyticsAvailable, pageview, event, trackConversion } from './gtag';

export {
  trackCTAClick,
  trackConsultationBooking,
  trackNavigation,
  trackProjectView,
  trackProjectFilter,
  trackContactFormSubmit,
  trackLeadQualifierSubmit,
  trackOutboundLink,
  trackSocialClick,
  trackScrollDepth,
} from './events';
```

### Tests

#### `src/__tests__/lib/analytics/gtag.test.ts`
```typescript
import { isAnalyticsAvailable, pageview, event } from '@/lib/analytics/gtag';

describe('Google Analytics gtag', () => {
  const originalWindow = global.window;

  beforeEach(() => {
    // Reset window.gtag before each test
    (global as any).window = {
      gtag: jest.fn(),
      dataLayer: [],
    };
  });

  afterEach(() => {
    global.window = originalWindow;
  });

  describe('isAnalyticsAvailable', () => {
    it('should return false when window is undefined', () => {
      const windowBackup = global.window;
      delete (global as any).window;
      expect(isAnalyticsAvailable()).toBe(false);
      global.window = windowBackup;
    });

    it('should return false when gtag is not defined', () => {
      delete (window as any).gtag;
      expect(isAnalyticsAvailable()).toBe(false);
    });
  });

  describe('pageview', () => {
    it('should call gtag with correct parameters', () => {
      // Mock GA_MEASUREMENT_ID by setting env variable
      const originalEnv = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;
      process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID = 'G-TEST123';

      pageview('/test-page');

      // Since isAnalyticsAvailable checks for GA_MEASUREMENT_ID at module level,
      // this test verifies the function doesn't throw
      expect(true).toBe(true);

      process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID = originalEnv;
    });
  });

  describe('event', () => {
    it('should not throw when analytics is unavailable', () => {
      delete (window as any).gtag;
      expect(() => {
        event('test_action', 'test_category', 'test_label', 100);
      }).not.toThrow();
    });
  });
});
```

#### `src/__tests__/lib/analytics/events.test.ts`
```typescript
import {
  trackCTAClick,
  trackConsultationBooking,
  trackProjectView,
  trackContactFormSubmit,
} from '@/lib/analytics/events';

// Mock the gtag module
jest.mock('@/lib/analytics/gtag', () => ({
  event: jest.fn(),
  trackConversion: jest.fn(),
  isAnalyticsAvailable: () => true,
}));

describe('Analytics Events', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('should track CTA clicks', () => {
    expect(() => {
      trackCTAClick('Book Consultation', 'Header');
    }).not.toThrow();
  });

  it('should track consultation booking', () => {
    expect(() => {
      trackConsultationBooking();
    }).not.toThrow();
  });

  it('should track project views', () => {
    expect(() => {
      trackProjectView('Insyt');
    }).not.toThrow();
  });

  it('should track contact form submissions', () => {
    expect(() => {
      trackContactFormSubmit();
    }).not.toThrow();
  });
});
```

---

## Layout Integration

Add to `src/app/layout.tsx` (coordinate via SHARED_NOTES.md):

```typescript
import GoogleAnalytics from '@/components/Common/Analytics/GoogleAnalytics';

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <GoogleAnalytics />
        {/* ... rest of layout */}
      </body>
    </html>
  );
}
```

---

## Usage Examples

### In Components

```typescript
import { trackCTAClick } from '@/lib/analytics';

const Button = () => {
  const handleClick = () => {
    trackCTAClick('Book Consultation', 'Hero Section');
  };

  return <button onClick={handleClick}>Book Now</button>;
};
```

### In Pages

```typescript
import { trackProjectView } from '@/lib/analytics';
import { useEffect } from 'react';

const ProjectPage = ({ project }) => {
  useEffect(() => {
    trackProjectView(project.title);
  }, [project.title]);

  return <div>...</div>;
};
```

---

## Acceptance Criteria

- [ ] Google Analytics script loads correctly
- [ ] Page views are tracked automatically on route changes
- [ ] Event tracking utilities are available and typed
- [ ] Analytics component handles missing GA ID gracefully
- [ ] Environment variables are documented
- [ ] No analytics errors in console
- [ ] All tests pass
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds

---

## On Completion

1. Update `EXECUTION.md`: Mark T015 as `completed`
2. Update `SHARED_NOTES.md`:
   - Document the analytics integration pattern
   - Note that layout.tsx needs GoogleAnalytics component
3. Commit: `git commit -m "T015: Add Google Analytics 4 integration with event tracking"`
