# T017: Performance Optimization & Lighthouse Audit

## Overview

**Task ID**: T017
**Phase**: 5 - Finalization
**Priority**: Critical
**Dependencies**: All previous tasks (T001-T016)
**Estimated Complexity**: Medium

## Objective

Optimize the website to meet Lighthouse targets (Performance 90+, Accessibility 95+, Best Practices 95+, SEO 95+), implement performance best practices, and ensure excellent Core Web Vitals scores.

---

## Prerequisites

Before starting this task:
1. Read `CLAUDE.md` for agent rules
2. Check `EXECUTION.md` - Ensure ALL previous tasks (T001-T016) are `completed`
3. Mark this task as `in_progress` in `EXECUTION.md`
4. Read `SHARED_NOTES.md` for any learnings from other tasks

---

## File Ownership

This task has special permission to modify any file for performance fixes, but all changes must be documented.

```
MAY MODIFY:
- next.config.js (optimization settings)
- src/app/layout.tsx (font optimization, preloads)
- Any component file (with documentation)
- package.json (add performance dependencies if needed)

CREATE:
- src/lib/performance/index.ts
- src/__tests__/performance/lighthouse.test.ts
```

---

## Target Metrics

| Metric | Target | Description |
|--------|--------|-------------|
| Performance | 90+ | Overall performance score |
| Accessibility | 95+ | WCAG compliance |
| Best Practices | 95+ | Modern web standards |
| SEO | 95+ | Search engine optimization |
| FCP | < 1.8s | First Contentful Paint |
| LCP | < 2.5s | Largest Contentful Paint |
| TBT | < 200ms | Total Blocking Time |
| CLS | < 0.1 | Cumulative Layout Shift |

---

## Optimization Checklist

### 1. Image Optimization

- [ ] All images use Next.js `<Image>` component
- [ ] Images have explicit width/height to prevent CLS
- [ ] Images have appropriate `sizes` attribute
- [ ] Images use modern formats (WebP/AVIF via Next.js)
- [ ] Images have lazy loading (default in Next.js)
- [ ] Critical images have `priority` prop
- [ ] Image placeholders or blur-up implemented

### 2. Font Optimization

- [ ] Fonts are preloaded
- [ ] Font display: swap implemented
- [ ] Subset fonts if possible
- [ ] Use Next.js font optimization

#### Font Configuration

Update `src/app/layout.tsx`:

```typescript
import { Inter } from 'next/font/google';

// If using Google Fonts
const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-inter',
});

// For SF Pro (system font stack fallback)
// The existing setup should use font-display: swap
```

### 3. JavaScript Optimization

- [ ] No render-blocking scripts
- [ ] Third-party scripts loaded with `strategy="lazyOnload"` where possible
- [ ] Dynamic imports for non-critical components
- [ ] Code splitting via Next.js automatic splitting
- [ ] Remove unused dependencies

#### Dynamic Import Example

```typescript
import dynamic from 'next/dynamic';

// Lazy load heavy components
const CalendlyEmbed = dynamic(
  () => import('@/components/Common/CalendlyEmbed'),
  {
    loading: () => <div>Loading...</div>,
    ssr: false
  }
);
```

### 4. CSS Optimization

- [ ] Critical CSS is inlined (styled-components handles this)
- [ ] No unused CSS
- [ ] CSS is minified in production

### 5. Caching & CDN

- [ ] Static assets have proper cache headers
- [ ] Vercel edge caching enabled
- [ ] ISR configured for dynamic pages

#### Next.js Config Updates

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  compiler: {
    styledComponents: true,
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'cdn.sanity.io',
        pathname: '/images/**',
      },
    ],
    formats: ['image/avif', 'image/webp'],
  },
  experimental: {
    optimizePackageImports: ['framer-motion', 'styled-components'],
  },
  // Enable compression
  compress: true,
  // Power optimizations
  poweredByHeader: false,
  // Enable React strict mode for catching issues
  reactStrictMode: true,
};

module.exports = nextConfig;
```

### 6. Accessibility Fixes

- [ ] All images have alt text
- [ ] Proper heading hierarchy (h1 → h2 → h3)
- [ ] Color contrast meets WCAG AA (4.5:1 for text)
- [ ] Focus states are visible
- [ ] Interactive elements have proper labels
- [ ] Skip to content link
- [ ] Proper ARIA attributes where needed
- [ ] Form inputs have associated labels

#### Skip to Content Link

Add to `src/app/layout.tsx`:

```typescript
<body>
  <a href="#main-content" className="skip-link">
    Skip to main content
  </a>
  {/* ... */}
  <main id="main-content">
    {children}
  </main>
</body>
```

```css
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: #ECFF88;
  color: #070606;
  padding: 8px;
  z-index: 100;
}

.skip-link:focus {
  top: 0;
}
```

### 7. Best Practices

- [ ] HTTPS enabled (Vercel default)
- [ ] No browser errors in console
- [ ] No deprecated APIs
- [ ] Secure cookies (if applicable)
- [ ] No vulnerable dependencies

### 8. Core Web Vitals

#### LCP Optimization
- Preload hero images
- Optimize largest content element
- Use `priority` on above-fold images

#### CLS Optimization
- Set dimensions on images/videos
- Reserve space for dynamic content
- Use transform for animations

#### FID/TBT Optimization
- Break up long tasks
- Defer non-critical JavaScript
- Use Web Workers for heavy computation

---

## Performance Testing Script

#### `src/lib/performance/index.ts`

```typescript
// Performance monitoring utilities

export const measureWebVitals = () => {
  if (typeof window === 'undefined') return;

  // Report Web Vitals to analytics
  const reportWebVitals = (metric: {
    name: string;
    value: number;
    id: string;
  }) => {
    // Log to console in development
    if (process.env.NODE_ENV === 'development') {
      console.log(`[Web Vitals] ${metric.name}:`, metric.value);
    }

    // Send to analytics in production
    if (typeof window.gtag !== 'undefined') {
      window.gtag('event', metric.name, {
        event_category: 'Web Vitals',
        event_label: metric.id,
        value: Math.round(metric.value),
        non_interaction: true,
      });
    }
  };

  // Dynamically import web-vitals
  import('web-vitals').then(({ onCLS, onFID, onFCP, onLCP, onTTFB }) => {
    onCLS(reportWebVitals);
    onFID(reportWebVitals);
    onFCP(reportWebVitals);
    onLCP(reportWebVitals);
    onTTFB(reportWebVitals);
  });
};

// Image preload helper
export const preloadImage = (src: string) => {
  if (typeof window === 'undefined') return;

  const link = document.createElement('link');
  link.rel = 'preload';
  link.as = 'image';
  link.href = src;
  document.head.appendChild(link);
};

// Font preload helper
export const preloadFont = (href: string, type = 'font/woff2') => {
  if (typeof document === 'undefined') return;

  const link = document.createElement('link');
  link.rel = 'preload';
  link.as = 'font';
  link.type = type;
  link.href = href;
  link.crossOrigin = 'anonymous';
  document.head.appendChild(link);
};
```

---

## Lighthouse Testing

### Manual Testing Process

1. Build production version: `npm run build`
2. Start production server: `npm start`
3. Open Chrome DevTools → Lighthouse tab
4. Run audit for Mobile and Desktop
5. Document scores and issues

### Automated Test Placeholder

#### `src/__tests__/performance/lighthouse.test.ts`

```typescript
/**
 * Lighthouse Performance Tests
 *
 * These tests verify that performance optimizations are in place.
 * Actual Lighthouse scores must be tested manually or via CI.
 */

describe('Performance Optimizations', () => {
  describe('Images', () => {
    it('should have Next.js Image component available', () => {
      // This is a placeholder - actual image optimization is
      // verified via Lighthouse audit
      expect(true).toBe(true);
    });
  });

  describe('Fonts', () => {
    it('should have font optimization configured', () => {
      // Font optimization is configured in layout.tsx
      expect(true).toBe(true);
    });
  });

  describe('Build Output', () => {
    it('should produce optimized build', () => {
      // This would be run as part of the build process
      // npm run build should complete without errors
      expect(true).toBe(true);
    });
  });
});

// Note: For actual Lighthouse testing in CI, consider using:
// - lighthouse-ci
// - @lhci/cli
// Example CI command: lhci autorun
```

---

## Audit Procedure

### Step 1: Initial Audit
Run Lighthouse on all pages and document baseline scores.

### Step 2: Identify Issues
Review Lighthouse recommendations for each category.

### Step 3: Fix Issues
Address each issue, prioritizing:
1. Critical accessibility issues
2. LCP/CLS fixes
3. Best practices warnings
4. SEO issues

### Step 4: Re-audit
Run Lighthouse again to verify improvements.

### Step 5: Document
Record final scores and any remaining issues.

---

## Pages to Audit

| Page | URL | Priority |
|------|-----|----------|
| Homepage | / | High |
| Services | /services | High |
| Projects | /projects | Medium |
| Project Detail | /projects/[slug] | Medium |
| About | /about | Medium |
| Contact | /contact | High |
| Book Consultation | /book-consultation | Critical |

---

## Common Issues & Fixes

### Issue: LCP too slow
**Fix**: Preload hero image, use `priority` prop

### Issue: CLS high
**Fix**: Add width/height to images, reserve space for dynamic content

### Issue: TBT high
**Fix**: Code split, lazy load non-critical components

### Issue: Color contrast
**Fix**: Adjust colors to meet 4.5:1 ratio

### Issue: Missing alt text
**Fix**: Add descriptive alt text to all images

### Issue: Missing form labels
**Fix**: Associate labels with inputs using `htmlFor`

---

## Acceptance Criteria

- [ ] Lighthouse Performance score: 90+
- [ ] Lighthouse Accessibility score: 95+
- [ ] Lighthouse Best Practices score: 95+
- [ ] Lighthouse SEO score: 95+
- [ ] LCP < 2.5s on all pages
- [ ] CLS < 0.1 on all pages
- [ ] No critical accessibility issues
- [ ] No console errors
- [ ] All tests pass
- [ ] `npm run build` succeeds
- [ ] Production build tested

---

## Documentation Required

Document in `SHARED_NOTES.md`:
1. Final Lighthouse scores for each page
2. Any issues that couldn't be fixed and why
3. Performance optimizations applied
4. Recommendations for future improvements

---

## On Completion

1. Update `EXECUTION.md`:
   - Mark T017 as `completed`
   - Update overall project status to COMPLETE

2. Update `SHARED_NOTES.md`:
   - Add final Lighthouse scores
   - Document optimization techniques used
   - List any known limitations

3. Final commit:
   ```bash
   git add .
   git commit -m "T017: Performance optimization - Lighthouse scores achieved"
   ```

4. Create summary in `SHARED_NOTES.md`:
   ```markdown
   ## Project Complete

   All 17 tasks have been completed. Final status:
   - All tests passing
   - Lighthouse targets met
   - Production build successful
   ```
