# T001: Testing Infrastructure & Project Configuration

## Overview

**Task ID**: T001
**Phase**: 1 - Foundation
**Priority**: Critical (Blocks all other tasks)
**Dependencies**: None
**Estimated Complexity**: High

## Objective

Set up a complete testing infrastructure using Jest and React Testing Library for the Xerence web application. This includes configuring Jest to work with Next.js 15, styled-components, and TypeScript, creating test utilities and mocks, and establishing testing patterns for the project.

---

## Prerequisites

Before starting this task:
1. Read `CLAUDE.md` for agent rules
2. Check `EXECUTION.md` and mark this task as `in_progress`
3. Read `SHARED_NOTES.md` for any relevant notes
4. Ensure you have a clean working directory (`git status`)

---

## File Ownership

This task owns the following files (only modify these):

```
CREATE:
- jest.config.js
- jest.setup.js
- src/__tests__/test-utils.tsx
- src/__tests__/mocks/styleMock.js
- src/__tests__/mocks/fileMock.js
- src/__tests__/mocks/framerMotionMock.tsx
- src/__tests__/mocks/nextRouterMock.tsx
- src/__tests__/mocks/intersectionObserverMock.js
- src/__tests__/example.test.tsx (verification test)

MODIFY:
- package.json (add test dependencies and scripts)
- tsconfig.json (add jest types if needed)
```

---

## Detailed Requirements

### 1. Install Dependencies

Add the following dev dependencies to `package.json`:

```json
{
  "devDependencies": {
    "@testing-library/jest-dom": "^6.4.0",
    "@testing-library/react": "^14.2.0",
    "@testing-library/user-event": "^14.5.0",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "jest-styled-components": "^7.2.0",
    "@types/jest": "^29.5.0",
    "ts-node": "^10.9.0"
  }
}
```

### 2. Add NPM Scripts

Add these scripts to `package.json`:

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2"
  }
}
```

### 3. Create Jest Configuration

Create `jest.config.js` in project root:

```javascript
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  // Provide the path to your Next.js app to load next.config.js and .env files
  dir: './',
});

// Add any custom config to be passed to Jest
const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  moduleNameMapper: {
    // Handle module aliases (must match tsconfig paths)
    '^@/(.*)$': '<rootDir>/src/$1',
    // Handle CSS imports (with CSS modules)
    '^.+\\.module\\.(css|sass|scss)$': 'identity-obj-proxy',
    // Handle CSS imports (without CSS modules)
    '^.+\\.(css|sass|scss)$': '<rootDir>/src/__tests__/mocks/styleMock.js',
    // Handle image imports
    '^.+\\.(png|jpg|jpeg|gif|webp|avif|ico|bmp|svg)$': '<rootDir>/src/__tests__/mocks/fileMock.js',
    // Handle framer-motion
    '^framer-motion$': '<rootDir>/src/__tests__/mocks/framerMotionMock.tsx',
  },
  testPathIgnorePatterns: ['<rootDir>/node_modules/', '<rootDir>/.next/'],
  transform: {
    // Use babel-jest to transpile tests with the next/babel preset
    '^.+\\.(js|jsx|ts|tsx)$': ['babel-jest', { presets: ['next/babel'] }],
  },
  transformIgnorePatterns: [
    '/node_modules/',
    '^.+\\.module\\.(css|sass|scss)$',
  ],
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/app/layout.tsx',
    '!src/app/*/layout.tsx',
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70,
    },
  },
};

// createJestConfig is exported this way to ensure that next/jest can load the Next.js config which is async
module.exports = createJestConfig(customJestConfig);
```

### 4. Create Jest Setup File

Create `jest.setup.js` in project root:

```javascript
// Import jest-dom for extended matchers
import '@testing-library/jest-dom';

// Import styled-components jest utilities
import 'jest-styled-components';

// Mock IntersectionObserver
import './src/__tests__/mocks/intersectionObserverMock';

// Mock Next.js router
jest.mock('next/navigation', () => require('./src/__tests__/mocks/nextRouterMock'));

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation((query) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(), // deprecated
    removeListener: jest.fn(), // deprecated
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});

// Mock window.scrollTo
Object.defineProperty(window, 'scrollTo', {
  writable: true,
  value: jest.fn(),
});

// Suppress console errors during tests (optional, remove if you want to see them)
// const originalError = console.error;
// beforeAll(() => {
//   console.error = (...args) => {
//     if (
//       typeof args[0] === 'string' &&
//       args[0].includes('Warning: ReactDOM.render is no longer supported')
//     ) {
//       return;
//     }
//     originalError.call(console, ...args);
//   };
// });
// afterAll(() => {
//   console.error = originalError;
// });
```

### 5. Create Mock Files

#### `src/__tests__/mocks/styleMock.js`
```javascript
module.exports = {};
```

#### `src/__tests__/mocks/fileMock.js`
```javascript
module.exports = 'test-file-stub';
```

#### `src/__tests__/mocks/intersectionObserverMock.js`
```javascript
class IntersectionObserverMock {
  constructor(callback) {
    this.callback = callback;
  }

  observe() {
    return null;
  }

  unobserve() {
    return null;
  }

  disconnect() {
    return null;
  }
}

global.IntersectionObserver = IntersectionObserverMock;
```

#### `src/__tests__/mocks/framerMotionMock.tsx`
```typescript
import React from 'react';

// Mock framer-motion to avoid animation issues in tests
const actual = jest.requireActual('framer-motion');

const motion = {
  div: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <div ref={ref} {...props}>
      {children}
    </div>
  )),
  span: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <span ref={ref} {...props}>
      {children}
    </span>
  )),
  p: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <p ref={ref} {...props}>
      {children}
    </p>
  )),
  h1: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <h1 ref={ref} {...props}>
      {children}
    </h1>
  )),
  h2: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <h2 ref={ref} {...props}>
      {children}
    </h2>
  )),
  h3: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <h3 ref={ref} {...props}>
      {children}
    </h3>
  )),
  section: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <section ref={ref} {...props}>
      {children}
    </section>
  )),
  article: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <article ref={ref} {...props}>
      {children}
    </article>
  )),
  header: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <header ref={ref} {...props}>
      {children}
    </header>
  )),
  footer: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <footer ref={ref} {...props}>
      {children}
    </footer>
  )),
  nav: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <nav ref={ref} {...props}>
      {children}
    </nav>
  )),
  ul: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <ul ref={ref} {...props}>
      {children}
    </ul>
  )),
  li: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <li ref={ref} {...props}>
      {children}
    </li>
  )),
  a: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <a ref={ref} {...props}>
      {children}
    </a>
  )),
  button: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <button ref={ref} {...props}>
      {children}
    </button>
  )),
  img: React.forwardRef((props: any, ref: any) => <img ref={ref} {...props} />),
  svg: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <svg ref={ref} {...props}>
      {children}
    </svg>
  )),
  path: React.forwardRef((props: any, ref: any) => <path ref={ref} {...props} />),
  form: React.forwardRef(({ children, ...props }: any, ref: any) => (
    <form ref={ref} {...props}>
      {children}
    </form>
  )),
  input: React.forwardRef((props: any, ref: any) => <input ref={ref} {...props} />),
  textarea: React.forwardRef((props: any, ref: any) => <textarea ref={ref} {...props} />),
};

// Set display names for debugging
Object.keys(motion).forEach((key) => {
  (motion as any)[key].displayName = `motion.${key}`;
});

export const AnimatePresence = ({ children }: { children: React.ReactNode }) => <>{children}</>;
export const useAnimation = () => ({
  start: jest.fn(),
  stop: jest.fn(),
  set: jest.fn(),
});
export const useInView = () => true;
export const useScroll = () => ({ scrollY: { get: () => 0 }, scrollYProgress: { get: () => 0 } });
export const useTransform = () => 0;
export const useSpring = () => 0;
export const useMotionValue = (initial: number) => ({
  get: () => initial,
  set: jest.fn(),
  onChange: jest.fn(),
});
export const useReducedMotion = () => false;

export { motion };
export default { motion, AnimatePresence };
```

#### `src/__tests__/mocks/nextRouterMock.tsx`
```typescript
// Mock for next/navigation
export const useRouter = () => ({
  push: jest.fn(),
  replace: jest.fn(),
  prefetch: jest.fn(),
  back: jest.fn(),
  forward: jest.fn(),
  refresh: jest.fn(),
});

export const usePathname = () => '/';

export const useSearchParams = () => new URLSearchParams();

export const useParams = () => ({});

export const redirect = jest.fn();

export const notFound = jest.fn();

// For next/link
export const useSelectedLayoutSegment = () => null;
export const useSelectedLayoutSegments = () => [];
```

### 6. Create Test Utilities

Create `src/__tests__/test-utils.tsx`:

```typescript
import React, { ReactElement } from 'react';
import { render, RenderOptions } from '@testing-library/react';
import { ThemeProvider } from 'styled-components';

// This will be replaced with the actual theme from T003
// For now, use a placeholder theme
const theme = {
  colors: {
    background: '#070606',
    white: '#ffffff',
    lightGray: '#dcdcdc',
    linkColor: '#bdbdbc',
    green: '#ECFF88',
    emerald: '#ECFF88',
  },
  breakpoints: {
    mobile: '768px',
  },
};

interface AllTheProvidersProps {
  children: React.ReactNode;
}

const AllTheProviders = ({ children }: AllTheProvidersProps) => {
  return <ThemeProvider theme={theme}>{children}</ThemeProvider>;
};

const customRender = (
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>
) => render(ui, { wrapper: AllTheProviders, ...options });

// Re-export everything
export * from '@testing-library/react';
export { customRender as render };
export { theme as testTheme };
```

### 7. Create Verification Test

Create `src/__tests__/example.test.tsx` to verify the setup works:

```typescript
import React from 'react';
import { render, screen } from './test-utils';
import styled from 'styled-components';

// Simple test component
const TestComponent = styled.div`
  color: ${({ theme }) => theme.colors.white};
  background: ${({ theme }) => theme.colors.background};
`;

const SimpleComponent: React.FC<{ title: string }> = ({ title }) => {
  return (
    <TestComponent data-testid="test-component">
      <h1>{title}</h1>
    </TestComponent>
  );
};

describe('Testing Infrastructure Verification', () => {
  describe('Jest Setup', () => {
    it('should run a basic test', () => {
      expect(true).toBe(true);
    });

    it('should handle async tests', async () => {
      const result = await Promise.resolve(42);
      expect(result).toBe(42);
    });
  });

  describe('React Testing Library', () => {
    it('should render a component', () => {
      render(<SimpleComponent title="Test Title" />);
      expect(screen.getByText('Test Title')).toBeInTheDocument();
    });

    it('should find elements by test id', () => {
      render(<SimpleComponent title="Hello" />);
      expect(screen.getByTestId('test-component')).toBeInTheDocument();
    });
  });

  describe('Styled Components', () => {
    it('should render styled components with theme', () => {
      render(<SimpleComponent title="Styled Test" />);
      const component = screen.getByTestId('test-component');
      expect(component).toBeInTheDocument();
    });

    it('should have styled-components jest matchers available', () => {
      render(<SimpleComponent title="Matcher Test" />);
      const component = screen.getByTestId('test-component');
      expect(component).toHaveStyleRule('color', '#ffffff');
      expect(component).toHaveStyleRule('background', '#070606');
    });
  });

  describe('Jest DOM Matchers', () => {
    it('should have extended matchers available', () => {
      render(<SimpleComponent title="DOM Matchers" />);
      const heading = screen.getByRole('heading', { level: 1 });
      expect(heading).toBeVisible();
      expect(heading).toHaveTextContent('DOM Matchers');
    });
  });

  describe('Mocks', () => {
    it('should have IntersectionObserver mocked', () => {
      expect(global.IntersectionObserver).toBeDefined();
    });

    it('should have matchMedia mocked', () => {
      expect(window.matchMedia).toBeDefined();
      const result = window.matchMedia('(min-width: 768px)');
      expect(result.matches).toBe(false);
    });
  });
});
```

---

## Implementation Steps

Follow TDD methodology:

### Step 1: Create Directory Structure
```bash
mkdir -p src/__tests__/mocks
```

### Step 2: Install Dependencies
```bash
npm install --save-dev @testing-library/jest-dom @testing-library/react @testing-library/user-event jest jest-environment-jsdom jest-styled-components @types/jest ts-node
```

### Step 3: Create Configuration Files
1. Create `jest.config.js`
2. Create `jest.setup.js`

### Step 4: Create Mock Files
1. Create all mock files in `src/__tests__/mocks/`

### Step 5: Create Test Utilities
1. Create `src/__tests__/test-utils.tsx`

### Step 6: Create Verification Test
1. Create `src/__tests__/example.test.tsx`

### Step 7: Add Scripts to package.json
Add test scripts

### Step 8: Run Tests
```bash
npm run test
```

All tests should pass.

---

## Acceptance Criteria

- [ ] All dependencies installed successfully (`npm install` completes without errors)
- [ ] `jest.config.js` properly configured for Next.js 15
- [ ] `jest.setup.js` includes all necessary setup
- [ ] All mock files created and functional
- [ ] Test utilities properly wrap components with providers
- [ ] Verification test file passes all tests
- [ ] `npm run test` exits with 0 errors
- [ ] `npm run test:coverage` generates coverage report
- [ ] `npm run lint` passes
- [ ] `npm run build` still works

---

## Verification Commands

Run these commands to verify completion:

```bash
# Run all tests
npm run test

# Run with coverage
npm run test:coverage

# Verify lint still passes
npm run lint

# Verify build still works
npm run build
```

---

## Common Issues & Solutions

### Issue: styled-components SSR mismatch
**Solution**: Ensure ThemeProvider is in test-utils.tsx

### Issue: Framer Motion animation errors
**Solution**: The framerMotionMock.tsx should handle this

### Issue: Next.js router not found
**Solution**: nextRouterMock.tsx provides the mock

### Issue: IntersectionObserver not defined
**Solution**: intersectionObserverMock.js provides the mock

---

## Notes for Future Tasks

- T003 will create the actual theme file - test-utils.tsx will need to import from `src/styles/theme.ts`
- Components should be tested using the custom `render` from test-utils.tsx
- Always mock external dependencies (APIs, etc.)

---

## On Completion

1. Update `EXECUTION.md`:
   - Mark T001 as `completed`
   - Mark T002, T003, T015 as `pending` (they're now unblocked)

2. Update `SHARED_NOTES.md`:
   - Add any learnings or gotchas discovered
   - Document the testing patterns established

3. Commit your changes:
   ```bash
   git add .
   git commit -m "T001: Add Jest testing infrastructure with React Testing Library"
   ```
