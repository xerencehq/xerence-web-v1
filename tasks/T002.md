# T002: Sanity CMS Complete Setup

## Overview

**Task ID**: T002
**Phase**: 1 - Foundation
**Priority**: Critical (Blocks T013, T014)
**Dependencies**: T001 (Testing Infrastructure)
**Estimated Complexity**: High

## Objective

Set up Sanity CMS with all required schemas, configure the Sanity client for data fetching, embed Sanity Studio in the Next.js app, and seed initial project data including Insyt as a sample project.

---

## Prerequisites

Before starting this task:
1. Read `CLAUDE.md` for agent rules
2. Check `EXECUTION.md` - Ensure T001 is `completed`
3. Mark this task as `in_progress` in `EXECUTION.md`
4. Read `SHARED_NOTES.md` for any relevant notes

---

## File Ownership

```
CREATE:
- sanity.config.ts
- sanity.cli.ts
- src/sanity/env.ts
- src/sanity/lib/client.ts
- src/sanity/lib/image.ts
- src/sanity/lib/queries.ts
- src/sanity/lib/fetch.ts
- src/sanity/schemas/index.ts
- src/sanity/schemas/project.ts
- src/sanity/schemas/siteSettings.ts
- src/sanity/schemas/blockContent.ts
- src/sanity/structure.ts
- src/app/studio/[[...tool]]/page.tsx
- src/app/studio/[[...tool]]/layout.tsx
- src/types/sanity.ts
- src/__tests__/sanity/queries.test.ts
- src/__tests__/sanity/client.test.ts

MODIFY:
- package.json (sanity dependencies only)
- next.config.js (sanity hostname for images)
- .env.local (create if not exists, sanity env vars)
- .gitignore (add .env.local if not present)
```

---

## Detailed Requirements

### 1. Install Sanity Dependencies

```bash
npm install sanity @sanity/vision @sanity/image-url next-sanity
```

Add to `package.json` scripts:
```json
{
  "scripts": {
    "sanity:dev": "sanity dev",
    "sanity:deploy": "sanity deploy",
    "sanity:build": "sanity build"
  }
}
```

### 2. Create Sanity Project

You'll need to create a Sanity project. For this task, use placeholder values that can be updated later:

```
Project ID: (will be set in .env.local)
Dataset: production
```

### 3. Environment Variables

Create `.env.local`:
```env
# Sanity Configuration
NEXT_PUBLIC_SANITY_PROJECT_ID=your_project_id
NEXT_PUBLIC_SANITY_DATASET=production
NEXT_PUBLIC_SANITY_API_VERSION=2024-01-01
SANITY_API_READ_TOKEN=your_read_token
```

Add to `.env.example` (create if not exists):
```env
# Sanity Configuration
NEXT_PUBLIC_SANITY_PROJECT_ID=
NEXT_PUBLIC_SANITY_DATASET=production
NEXT_PUBLIC_SANITY_API_VERSION=2024-01-01
SANITY_API_READ_TOKEN=
```

### 4. Sanity Configuration Files

#### `sanity.config.ts`
```typescript
import { defineConfig } from 'sanity';
import { structureTool } from 'sanity/structure';
import { visionTool } from '@sanity/vision';
import { schemaTypes } from './src/sanity/schemas';
import { structure } from './src/sanity/structure';

const projectId = process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!;
const dataset = process.env.NEXT_PUBLIC_SANITY_DATASET!;

export default defineConfig({
  name: 'xerence-studio',
  title: 'Xerence Studio',
  projectId,
  dataset,
  basePath: '/studio',
  plugins: [
    structureTool({ structure }),
    visionTool({ defaultApiVersion: '2024-01-01' }),
  ],
  schema: {
    types: schemaTypes,
  },
});
```

#### `sanity.cli.ts`
```typescript
import { defineCliConfig } from 'sanity/cli';

const projectId = process.env.NEXT_PUBLIC_SANITY_PROJECT_ID;
const dataset = process.env.NEXT_PUBLIC_SANITY_DATASET;

export default defineCliConfig({
  api: {
    projectId,
    dataset,
  },
});
```

#### `src/sanity/env.ts`
```typescript
export const apiVersion = process.env.NEXT_PUBLIC_SANITY_API_VERSION || '2024-01-01';
export const dataset = process.env.NEXT_PUBLIC_SANITY_DATASET || 'production';
export const projectId = process.env.NEXT_PUBLIC_SANITY_PROJECT_ID || '';

// Check for required environment variables
function assertValue<T>(v: T | undefined, errorMessage: string): T {
  if (v === undefined) {
    throw new Error(errorMessage);
  }
  return v;
}

export const useCdn = process.env.NODE_ENV === 'production';
```

### 5. Sanity Client & Utilities

#### `src/sanity/lib/client.ts`
```typescript
import { createClient } from 'next-sanity';
import { apiVersion, dataset, projectId, useCdn } from '../env';

export const client = createClient({
  projectId,
  dataset,
  apiVersion,
  useCdn,
});

// Client with auth token for previews
export const previewClient = createClient({
  projectId,
  dataset,
  apiVersion,
  useCdn: false,
  token: process.env.SANITY_API_READ_TOKEN,
});

export const getClient = (preview?: boolean) => (preview ? previewClient : client);
```

#### `src/sanity/lib/image.ts`
```typescript
import createImageUrlBuilder from '@sanity/image-url';
import type { Image } from 'sanity';
import { dataset, projectId } from '../env';

const imageBuilder = createImageUrlBuilder({
  projectId: projectId || '',
  dataset: dataset || '',
});

export const urlForImage = (source: Image | undefined) => {
  if (!source?.asset?._ref) {
    return undefined;
  }
  return imageBuilder.image(source).auto('format').fit('max');
};

export const urlForImageWithDimensions = (
  source: Image | undefined,
  width: number,
  height: number
) => {
  if (!source?.asset?._ref) {
    return undefined;
  }
  return imageBuilder
    .image(source)
    .width(width)
    .height(height)
    .auto('format')
    .fit('crop');
};
```

#### `src/sanity/lib/queries.ts`
```typescript
import { groq } from 'next-sanity';

// Project queries
export const allProjectsQuery = groq`
  *[_type == "project"] | order(publishedAt desc) {
    _id,
    title,
    slug,
    description,
    techStack,
    featuredImage,
    clientName,
    clientLogo,
    isFeatured,
    publishedAt
  }
`;

export const featuredProjectsQuery = groq`
  *[_type == "project" && isFeatured == true] | order(publishedAt desc)[0...4] {
    _id,
    title,
    slug,
    description,
    techStack,
    featuredImage,
    clientName,
    clientLogo,
    isFeatured,
    publishedAt
  }
`;

export const projectBySlugQuery = groq`
  *[_type == "project" && slug.current == $slug][0] {
    _id,
    title,
    slug,
    description,
    problem,
    solution,
    outcomes,
    techStack,
    featuredImage,
    gallery,
    clientName,
    clientLogo,
    projectUrl,
    isFeatured,
    publishedAt
  }
`;

export const projectSlugsQuery = groq`
  *[_type == "project" && defined(slug.current)][].slug.current
`;

// Site settings queries
export const siteSettingsQuery = groq`
  *[_type == "siteSettings"][0] {
    siteName,
    siteDescription,
    logo,
    socialLinks,
    contactEmail,
    contactPhone,
    address
  }
`;
```

#### `src/sanity/lib/fetch.ts`
```typescript
import 'server-only';
import { client } from './client';
import {
  allProjectsQuery,
  featuredProjectsQuery,
  projectBySlugQuery,
  projectSlugsQuery,
  siteSettingsQuery,
} from './queries';
import type { Project, ProjectListItem, SiteSettings } from '@/types/sanity';

export async function getAllProjects(): Promise<ProjectListItem[]> {
  return client.fetch(allProjectsQuery);
}

export async function getFeaturedProjects(): Promise<ProjectListItem[]> {
  return client.fetch(featuredProjectsQuery);
}

export async function getProjectBySlug(slug: string): Promise<Project | null> {
  return client.fetch(projectBySlugQuery, { slug });
}

export async function getProjectSlugs(): Promise<string[]> {
  return client.fetch(projectSlugsQuery);
}

export async function getSiteSettings(): Promise<SiteSettings | null> {
  return client.fetch(siteSettingsQuery);
}
```

### 6. Sanity Schemas

#### `src/sanity/schemas/index.ts`
```typescript
import project from './project';
import siteSettings from './siteSettings';
import blockContent from './blockContent';

export const schemaTypes = [project, siteSettings, blockContent];
```

#### `src/sanity/schemas/blockContent.ts`
```typescript
import { defineType, defineArrayMember } from 'sanity';

export default defineType({
  title: 'Block Content',
  name: 'blockContent',
  type: 'array',
  of: [
    defineArrayMember({
      title: 'Block',
      type: 'block',
      styles: [
        { title: 'Normal', value: 'normal' },
        { title: 'H2', value: 'h2' },
        { title: 'H3', value: 'h3' },
        { title: 'H4', value: 'h4' },
        { title: 'Quote', value: 'blockquote' },
      ],
      lists: [
        { title: 'Bullet', value: 'bullet' },
        { title: 'Numbered', value: 'number' },
      ],
      marks: {
        decorators: [
          { title: 'Strong', value: 'strong' },
          { title: 'Emphasis', value: 'em' },
          { title: 'Code', value: 'code' },
        ],
        annotations: [
          {
            title: 'URL',
            name: 'link',
            type: 'object',
            fields: [
              {
                title: 'URL',
                name: 'href',
                type: 'url',
              },
            ],
          },
        ],
      },
    }),
    defineArrayMember({
      type: 'image',
      options: { hotspot: true },
      fields: [
        {
          name: 'alt',
          type: 'string',
          title: 'Alternative Text',
        },
      ],
    }),
  ],
});
```

#### `src/sanity/schemas/project.ts`
```typescript
import { defineField, defineType } from 'sanity';

export default defineType({
  name: 'project',
  title: 'Project',
  type: 'document',
  fields: [
    defineField({
      name: 'title',
      title: 'Title',
      type: 'string',
      validation: (Rule) => Rule.required(),
    }),
    defineField({
      name: 'slug',
      title: 'Slug',
      type: 'slug',
      options: {
        source: 'title',
        maxLength: 96,
      },
      validation: (Rule) => Rule.required(),
    }),
    defineField({
      name: 'description',
      title: 'Short Description',
      type: 'text',
      rows: 3,
      validation: (Rule) => Rule.required().max(300),
    }),
    defineField({
      name: 'problem',
      title: 'The Problem',
      type: 'blockContent',
      description: 'Describe the problem or challenge this project addressed',
    }),
    defineField({
      name: 'solution',
      title: 'The Solution',
      type: 'blockContent',
      description: 'Describe how you solved the problem',
    }),
    defineField({
      name: 'outcomes',
      title: 'Outcomes',
      type: 'array',
      of: [{ type: 'string' }],
      description: 'Key results and metrics achieved',
    }),
    defineField({
      name: 'techStack',
      title: 'Tech Stack',
      type: 'array',
      of: [{ type: 'string' }],
      options: {
        layout: 'tags',
      },
    }),
    defineField({
      name: 'featuredImage',
      title: 'Featured Image',
      type: 'image',
      options: {
        hotspot: true,
      },
      fields: [
        {
          name: 'alt',
          type: 'string',
          title: 'Alternative Text',
        },
      ],
    }),
    defineField({
      name: 'gallery',
      title: 'Gallery',
      type: 'array',
      of: [
        {
          type: 'image',
          options: {
            hotspot: true,
          },
          fields: [
            {
              name: 'alt',
              type: 'string',
              title: 'Alternative Text',
            },
          ],
        },
      ],
    }),
    defineField({
      name: 'clientName',
      title: 'Client Name',
      type: 'string',
      description: 'Optional - leave blank for internal projects',
    }),
    defineField({
      name: 'clientLogo',
      title: 'Client Logo',
      type: 'image',
      description: 'Optional - client company logo',
      options: {
        hotspot: true,
      },
    }),
    defineField({
      name: 'projectUrl',
      title: 'Project URL',
      type: 'url',
      description: 'Optional - live project URL',
    }),
    defineField({
      name: 'isFeatured',
      title: 'Featured Project',
      type: 'boolean',
      initialValue: false,
      description: 'Show this project on the homepage',
    }),
    defineField({
      name: 'publishedAt',
      title: 'Published At',
      type: 'datetime',
    }),
  ],
  preview: {
    select: {
      title: 'title',
      media: 'featuredImage',
      featured: 'isFeatured',
    },
    prepare(selection) {
      const { title, media, featured } = selection;
      return {
        title: featured ? `â­ ${title}` : title,
        media,
      };
    },
  },
});
```

#### `src/sanity/schemas/siteSettings.ts`
```typescript
import { defineField, defineType } from 'sanity';

export default defineType({
  name: 'siteSettings',
  title: 'Site Settings',
  type: 'document',
  fields: [
    defineField({
      name: 'siteName',
      title: 'Site Name',
      type: 'string',
      initialValue: 'Xerence Innovations',
    }),
    defineField({
      name: 'siteDescription',
      title: 'Site Description',
      type: 'text',
      rows: 3,
    }),
    defineField({
      name: 'logo',
      title: 'Logo',
      type: 'image',
      options: {
        hotspot: true,
      },
    }),
    defineField({
      name: 'socialLinks',
      title: 'Social Links',
      type: 'object',
      fields: [
        { name: 'twitter', title: 'Twitter', type: 'url' },
        { name: 'linkedin', title: 'LinkedIn', type: 'url' },
        { name: 'github', title: 'GitHub', type: 'url' },
        { name: 'instagram', title: 'Instagram', type: 'url' },
      ],
    }),
    defineField({
      name: 'contactEmail',
      title: 'Contact Email',
      type: 'string',
      initialValue: 'hello@xerence.com',
    }),
    defineField({
      name: 'contactPhone',
      title: 'Contact Phone',
      type: 'string',
    }),
    defineField({
      name: 'address',
      title: 'Address',
      type: 'text',
      rows: 3,
    }),
  ],
  preview: {
    prepare() {
      return {
        title: 'Site Settings',
      };
    },
  },
});
```

#### `src/sanity/structure.ts`
```typescript
import type { StructureBuilder } from 'sanity/structure';

export const structure = (S: StructureBuilder) =>
  S.list()
    .title('Content')
    .items([
      S.listItem()
        .title('Site Settings')
        .child(S.document().schemaType('siteSettings').documentId('siteSettings')),
      S.divider(),
      S.listItem()
        .title('Projects')
        .schemaType('project')
        .child(S.documentTypeList('project').title('Projects')),
    ]);
```

### 7. TypeScript Types

#### `src/types/sanity.ts`
```typescript
import type { PortableTextBlock, Image } from 'sanity';

export interface SanitySlug {
  _type: 'slug';
  current: string;
}

export interface SanityImage extends Image {
  alt?: string;
}

export interface ProjectListItem {
  _id: string;
  title: string;
  slug: SanitySlug;
  description: string;
  techStack: string[];
  featuredImage?: SanityImage;
  clientName?: string;
  clientLogo?: SanityImage;
  isFeatured: boolean;
  publishedAt: string;
}

export interface Project extends ProjectListItem {
  problem?: PortableTextBlock[];
  solution?: PortableTextBlock[];
  outcomes?: string[];
  gallery?: SanityImage[];
  projectUrl?: string;
}

export interface SocialLinks {
  twitter?: string;
  linkedin?: string;
  github?: string;
  instagram?: string;
}

export interface SiteSettings {
  siteName: string;
  siteDescription: string;
  logo?: SanityImage;
  socialLinks?: SocialLinks;
  contactEmail: string;
  contactPhone?: string;
  address?: string;
}
```

### 8. Sanity Studio Pages

#### `src/app/studio/[[...tool]]/page.tsx`
```typescript
'use client';

import { NextStudio } from 'next-sanity/studio';
import config from '../../../../sanity.config';

export default function StudioPage() {
  return <NextStudio config={config} />;
}
```

#### `src/app/studio/[[...tool]]/layout.tsx`
```typescript
export const metadata = {
  title: 'Xerence Studio',
  description: 'Content management for Xerence website',
};

export default function StudioLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body style={{ margin: 0 }}>{children}</body>
    </html>
  );
}
```

### 9. Update Next.js Config

Add Sanity image hostname to `next.config.js`:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  compiler: {
    styledComponents: true,
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'cdn.sanity.io',
        pathname: '/images/**',
      },
    ],
  },
  // Ignore TypeScript errors in Sanity Studio
  typescript: {
    ignoreBuildErrors: false,
  },
};

module.exports = nextConfig;
```

### 10. Seed Data Script

Create a seed data document that can be imported via Sanity CLI or Studio. Document the seed data in `SHARED_NOTES.md`:

**Insyt Seed Project:**
```json
{
  "_type": "project",
  "title": "Insyt",
  "slug": { "_type": "slug", "current": "insyt" },
  "description": "An intelligent analytics platform that transforms raw data into actionable insights using AI-powered analysis.",
  "techStack": ["Next.js", "TypeScript", "Python", "TensorFlow", "PostgreSQL", "AWS"],
  "isFeatured": true,
  "publishedAt": "2024-01-01T00:00:00Z",
  "problem": [{"_type": "block", "children": [{"_type": "span", "text": "Businesses struggle to extract meaningful insights from their growing data. Traditional analytics tools require extensive manual analysis and technical expertise."}]}],
  "solution": [{"_type": "block", "children": [{"_type": "span", "text": "Insyt uses machine learning algorithms to automatically identify patterns, anomalies, and trends in data. The intuitive dashboard presents complex analytics in an easily digestible format."}]}],
  "outcomes": ["50% reduction in analysis time", "Real-time anomaly detection", "Automated report generation", "Self-service analytics for non-technical users"]
}
```

### 11. Tests

#### `src/__tests__/sanity/queries.test.ts`
```typescript
import {
  allProjectsQuery,
  featuredProjectsQuery,
  projectBySlugQuery,
  projectSlugsQuery,
  siteSettingsQuery,
} from '@/sanity/lib/queries';

describe('Sanity Queries', () => {
  describe('allProjectsQuery', () => {
    it('should be a valid GROQ query string', () => {
      expect(typeof allProjectsQuery).toBe('string');
      expect(allProjectsQuery).toContain('*[_type == "project"]');
    });

    it('should order by publishedAt desc', () => {
      expect(allProjectsQuery).toContain('order(publishedAt desc)');
    });

    it('should select required fields', () => {
      expect(allProjectsQuery).toContain('_id');
      expect(allProjectsQuery).toContain('title');
      expect(allProjectsQuery).toContain('slug');
      expect(allProjectsQuery).toContain('description');
    });
  });

  describe('featuredProjectsQuery', () => {
    it('should filter for featured projects only', () => {
      expect(featuredProjectsQuery).toContain('isFeatured == true');
    });

    it('should limit to 4 results', () => {
      expect(featuredProjectsQuery).toContain('[0...4]');
    });
  });

  describe('projectBySlugQuery', () => {
    it('should filter by slug parameter', () => {
      expect(projectBySlugQuery).toContain('slug.current == $slug');
    });

    it('should return single result', () => {
      expect(projectBySlugQuery).toContain('[0]');
    });

    it('should include detailed fields', () => {
      expect(projectBySlugQuery).toContain('problem');
      expect(projectBySlugQuery).toContain('solution');
      expect(projectBySlugQuery).toContain('outcomes');
      expect(projectBySlugQuery).toContain('gallery');
    });
  });

  describe('projectSlugsQuery', () => {
    it('should select only slug.current', () => {
      expect(projectSlugsQuery).toContain('slug.current');
    });

    it('should filter for defined slugs', () => {
      expect(projectSlugsQuery).toContain('defined(slug.current)');
    });
  });

  describe('siteSettingsQuery', () => {
    it('should query siteSettings type', () => {
      expect(siteSettingsQuery).toContain('_type == "siteSettings"');
    });

    it('should return single result', () => {
      expect(siteSettingsQuery).toContain('[0]');
    });
  });
});
```

#### `src/__tests__/sanity/client.test.ts`
```typescript
import { client, getClient } from '@/sanity/lib/client';

// Mock the environment variables
jest.mock('@/sanity/env', () => ({
  projectId: 'test-project-id',
  dataset: 'test-dataset',
  apiVersion: '2024-01-01',
  useCdn: false,
}));

describe('Sanity Client', () => {
  describe('client', () => {
    it('should be defined', () => {
      expect(client).toBeDefined();
    });

    it('should have fetch method', () => {
      expect(typeof client.fetch).toBe('function');
    });
  });

  describe('getClient', () => {
    it('should return client when preview is false', () => {
      const result = getClient(false);
      expect(result).toBeDefined();
    });

    it('should return client when preview is undefined', () => {
      const result = getClient();
      expect(result).toBeDefined();
    });
  });
});
```

---

## Implementation Steps

### Step 1: Install Dependencies
```bash
npm install sanity @sanity/vision @sanity/image-url next-sanity
```

### Step 2: Create Environment File
Create `.env.local` with placeholder values

### Step 3: Create Sanity Config Files
1. `sanity.config.ts`
2. `sanity.cli.ts`
3. `src/sanity/env.ts`

### Step 4: Create Client & Utilities
1. `src/sanity/lib/client.ts`
2. `src/sanity/lib/image.ts`
3. `src/sanity/lib/queries.ts`
4. `src/sanity/lib/fetch.ts`

### Step 5: Create Schemas
1. `src/sanity/schemas/blockContent.ts`
2. `src/sanity/schemas/project.ts`
3. `src/sanity/schemas/siteSettings.ts`
4. `src/sanity/schemas/index.ts`
5. `src/sanity/structure.ts`

### Step 6: Create Types
1. `src/types/sanity.ts`

### Step 7: Create Studio Pages
1. `src/app/studio/[[...tool]]/page.tsx`
2. `src/app/studio/[[...tool]]/layout.tsx`

### Step 8: Update Next Config
Add Sanity image hostname

### Step 9: Write Tests
1. `src/__tests__/sanity/queries.test.ts`
2. `src/__tests__/sanity/client.test.ts`

### Step 10: Run Verification
```bash
npm run test
npm run lint
npm run build
```

---

## Acceptance Criteria

- [ ] All Sanity dependencies installed
- [ ] Environment variables documented in `.env.example`
- [ ] Sanity client properly configured
- [ ] All schemas created and valid
- [ ] TypeScript types match schema definitions
- [ ] Sanity Studio accessible at `/studio`
- [ ] Image URL builder working
- [ ] GROQ queries well-structured
- [ ] Fetch utilities typed correctly
- [ ] All tests pass
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] Seed data for Insyt documented

---

## Verification Commands

```bash
# Run tests
npm run test

# Verify lint
npm run lint

# Verify build
npm run build

# Start dev server and check /studio
npm run dev
# Visit http://localhost:3000/studio
```

---

## Notes

- The actual Sanity project ID needs to be created via `npx sanity init` or the Sanity dashboard
- Seed data can be added via the Studio UI or using `sanity dataset import`
- The fetch utilities use `server-only` to ensure they only run on the server

---

## On Completion

1. Update `EXECUTION.md`:
   - Mark T002 as `completed`
   - Note that T013, T014 dependencies on T002 are now satisfied

2. Update `SHARED_NOTES.md`:
   - Document the Sanity setup process
   - Add Insyt seed data details
   - Note any configuration steps needed

3. Commit changes:
   ```bash
   git add .
   git commit -m "T002: Add Sanity CMS setup with schemas and studio"
   ```
